<!--pages/iotDevice/iotDeviceOperation.wxml-->
<view class="container">
  <!-- 自定义导航栏 -->

  <!-- 主要内容区域 -->
  <view class="main-content">
    <!-- 全局Loading遮罩 -->
    <view class="loading-overlay" wx:if="{{loading}}">
      <view class="loading-content">
        <van-loading type="spinner" size="24px" color="#07c160" />
        <text class="loading-text">加载设备数据中...</text>
      </view>
    </view>
    <!-- 当前设备信息卡片 -->
    <view class="device-info-card">
      <view class="card-header">
        <view class="device-name">
          <text wx:if="{{!deviceInfoLoading}}">{{deviceInfo.name || '设备名称'}}</text>
          <view wx:else class="loading-placeholder">
            <van-loading type="spinner" size="16px" color="#07c160" />
            <text>加载设备信息中...</text>
          </view>
        </view>
        <view class="device-status" style="color: {{getStatusColor(deviceStatus)}}">
          <text wx:if="{{!deviceInfoLoading}}">{{getStatusText(deviceStatus)}}</text>
          <text wx:else>加载中...</text>
        </view>
      </view>
      
      <view class="device-details">
        <view class="detail-item">
          <text class="label">设备ID:</text>
          <text class="value">
            <text wx:if="{{!deviceInfoLoading}}">{{deviceInfo.iotId || '未知'}}</text>
            <text wx:else class="loading-text">加载中...</text>
          </text>
        </view>
        <view class="detail-item">
          <text class="label">产品Key:</text>
          <text class="value">
            <text wx:if="{{!deviceInfoLoading}}">{{deviceInfo.productKey || '未知'}}</text>
            <text wx:else class="loading-text">加载中...</text>
          </text>
        </view>
        <view class="detail-item">
          <text class="label">设备名:</text>
          <text class="value">
            <text wx:if="{{!deviceInfoLoading}}">{{deviceInfo.deviceName || '未知'}}</text>
            <text wx:else class="loading-text">加载中...</text>
          </text>
        </view>
        <view class="detail-item">
          <text class="label">创建时间:</text>
          <text class="value">
            <text wx:if="{{!deviceInfoLoading}}">{{formatTimestamp(deviceInfo.gmtCreate) || '未知'}}</text>
            <text wx:else class="loading-text">加载中...</text>
          </text>
        </view>
        <view class="detail-item">
          <text class="label">最后修改:</text>
          <text class="value">
            <text wx:if="{{!deviceInfoLoading}}">{{formatTimestamp(deviceInfo.gmtModified) || '未知'}}</text>
            <text wx:else class="loading-text">加载中...</text>
          </text>
        </view>
      </view>
    </view>

    <!-- 设备开关控制卡片 -->
    <view class="device-control-card">
      <view class="card-title">设备控制</view>
      <view class="control-panel">
        <view class="control-item">
          <view class="control-info">
            <text class="control-name">主开关</text>
            <text class="control-desc">控制设备总电源 (CHSWT1/CHSWT2)</text>
          </view>
          <view wx:if="{{!propertiesLoading}}">
            <van-switch 
              size="24px" 
              checked="{{ (propertyValues.CHSWT1 == '1' || propertyValues.CHSWT1 == 1 || propertyValues.CHSWT1) || (propertyValues.CHSWT2 == '1' || propertyValues.CHSWT2 == 1 || propertyValues.CHSWT2) }}"
              bind:change="onDeviceMainSwitch"
              disabled="{{deviceStatus === 0 || deviceStatus === 8}}"
            />
          </view>
          <view wx:else class="loading-placeholder">
            <van-loading type="spinner" size="16px" color="#07c160" />
            <text>加载中...</text>
          </view>
        </view>
        
        <!-- 基于属性的开关控制 -->
        <block wx:if="{{templateProperties.length > 0 && !templateLoading}}">
          <view class="control-item" wx:for="{{templateProperties}}" wx:key="identifier" wx:if="{{item.dataType.type === 'bool' && item.accessMode && item.accessMode.includes('w')}}">
            <view class="control-info">
              <text class="control-name">{{item.name}}</text>
              <text class="control-desc">{{item.desc || item.identifier}}</text>
            </view>
            <van-switch 
              size="24px"
              checked="{{propertyValues[item.identifier] == '1' || propertyValues[item.identifier] == 1 || propertyValues[item.identifier] === true}}"
              data-identifier="{{item.identifier}}"
              bind:change="onChangePropertySwitch"
            />
          </view>
        </block>
        
        <!-- 模板加载中 -->
        <view class="control-item" wx:if="{{templateLoading}}">
          <view class="control-info">
            <text class="control-name">加载中...</text>
            <text class="control-desc">正在获取设备模板</text>
          </view>
          <view class="loading-placeholder">
            <van-loading type="spinner" size="16px" color="#07c160" />
          </view>
        </view>
        
        <!-- 预设的常用开关（如果没有模板属性时使用） -->
        <block wx:if="{{templateProperties.length === 0 && !templateLoading}}">
          <view class="control-item">
            <view class="control-info">
              <text class="control-name">开关1</text>
              <text class="control-desc">CHSWT1</text>
            </view>
            <view wx:if="{{!propertiesLoading}}">
              <van-switch 
                size="24px" 
                checked="{{chswt1On}}"
                bind:change="onToggleChswt1"
              />
            </view>
            <view wx:else class="loading-placeholder">
              <van-loading type="spinner" size="16px" color="#07c160" />
            </view>
          </view>
          
          <view class="control-item">
            <view class="control-info">
              <text class="control-name">开关2</text>
              <text class="control-desc">CHSWT2</text>
            </view>
            <view wx:if="{{!propertiesLoading}}">
              <van-switch 
                size="24px" 
                checked="{{chswt2On}}"
                bind:change="onToggleChswt2"
              />
            </view>
            <view wx:else class="loading-placeholder">
              <van-loading type="spinner" size="16px" color="#07c160" />
            </view>
          </view>
        </block>
      </view>
    </view>

    <!-- 设备属性卡片 -->
    <view class="properties-card">
      <view class="card-title">设备属性</view>
      <view class="properties-list">
        <!-- 属性加载中 -->
        <view class="property-item" wx:if="{{propertiesLoading || templateLoading}}">
          <view class="property-header">
            <text class="property-name">加载中...</text>
          </view>
          <view class="property-value">
            <view class="loading-placeholder">
              <van-loading type="spinner" size="16px" color="#07c160" />
              <text>正在获取设备属性</text>
            </view>
          </view>
        </view>
        
        <!-- 根据模板渲染所有属性（优先模板），否则回退到快照 -->
        <block wx:elif="{{templateProperties.length && !templateLoading}}">
          <view class="property-item" wx:for="{{templateProperties}}" wx:key="identifier">
            <view class="property-header">
              <text class="property-name">{{item.name}}（{{item.identifier}}）</text>
              <text class="property-time" wx:if="{{deviceInfo.gmtModified}}">{{formatTimestamp(deviceInfo.gmtModified)}}</text>
            </view>
            <view class="property-value">
              <!-- bool 类型用开关（保存 1/0） -->
              <block wx:if="{{item.dataType.type === 'bool'}}">
                <van-switch size="24px"
                            checked="{{propertyValues[item.identifier] == '1' || propertyValues[item.identifier] == 1 || propertyValues[item.identifier] === true}}"
                            data-identifier="{{item.identifier}}"
                            bind:change="onChangePropertySwitch" />
                <van-button size="mini" type="primary" data-identifier="{{item.identifier}}" bind:click="onSubmitSingleProperty" style="margin-top:8px">下发</van-button>
              </block>

              <!-- enum 类型用选择器（显示中文，保存枚举key） -->
              <block wx:elif="{{item.dataType.type === 'enum'}}">
                <view class="enum-row" bindtap="openEnumPicker" data-identifier="{{item.identifier}}">
                  <text>{{propertyValues[item.identifier] !== undefined ? (item.dataType.specs[propertyValues[item.identifier]] || propertyValues[item.identifier]) : '请选择'}}</text>
                  <van-icon name="arrow" size="16px" />
                </view>
                <van-button size="mini" type="primary" data-identifier="{{item.identifier}}" bind:click="onSubmitSingleProperty" style="margin-top:8px">下发</van-button>
              </block>

              <!-- 其他类型：text/int/float 用输入框 -->
              <block wx:else>
                <van-field placeholder="请输入"
                           value="{{propertyValues[item.identifier]}}"
                           data-identifier="{{item.identifier}}"
                           bind:change="onChangePropertyInput" />
                <van-button size="mini" type="primary" data-identifier="{{item.identifier}}" bind:click="onSubmitSingleProperty" style="margin-top:8px">下发</van-button>
              </block>
            </view>
          </view>
        </block>

        <!-- 回退：显示所有属性（可编辑） -->
        <block wx:elif="{{!propertiesLoading}}">
          <view class="property-item" wx:for="{{deviceProperties}}" wx:key="attribute">
            <view class="property-header">
              <text class="property-name">{{item.attribute}}</text>
              <text class="property-time">{{formatTimestamp(item.gmtModified)}}</text>
            </view>
            <view class="property-value">
              <!-- 根据属性值类型判断是否为布尔值 -->
              <block wx:if="{{item.value === 0 || item.value === 1 || item.value === '0' || item.value === '1' || item.value === true || item.value === false}}">
                <van-switch size="24px"
                            checked="{{item.value == '1' || item.value == 1 || item.value === true}}"
                            data-identifier="{{item.attribute}}"
                            bind:change="onChangePropertySwitch" />
                <van-button size="mini" type="primary" data-identifier="{{item.attribute}}" bind:click="onSubmitSingleProperty" style="margin-top:8px">下发</van-button>
              </block>
              
              <!-- 其他类型用输入框 -->
              <block wx:else>
                <van-field placeholder="请输入"
                           value="{{propertyValues[item.attribute] || item.value}}"
                           data-identifier="{{item.attribute}}"
                           bind:change="onChangePropertyInput" />
                <van-button size="mini" type="primary" data-identifier="{{item.attribute}}" bind:click="onSubmitSingleProperty" style="margin-top:8px">下发</van-button>
              </block>
            </view>
          </view>
        </block>
      </view>
      <view class="form-actions" wx:if="{{!propertiesLoading && !templateLoading}}">
        <van-button type="primary" size="small" bind:click="onSubmitAllProperties">批量下发全部可写属性</van-button>
      </view>
    </view>

    <!-- 属性设置卡片 -->
    <view class="property-set-card">
      <view class="card-title">属性设置</view>
      <view class="property-form">
        <van-field
          label="属性标识符"
          placeholder="请输入属性标识符"
          value="{{ propertyIdentifier }}"
          bind:change="onPropertyIdentifierInput"
          border="{{ false }}"
        />
        <van-field
          label="属性值"
          placeholder="请输入属性值"
          value="{{ propertyValue }}"
          bind:change="onPropertyValueInput"
          border="{{ false }}"
        />
        <view class="form-actions">
          <van-button type="primary" size="small" bind:click="onSetProperty">
            设置属性
          </van-button>
        </view>
      </view>
    </view>

    <!-- 历史数据查询卡片 -->
    <view class="history-query-card">
      <view class="card-title">历史数据查询</view>
      <view class="query-form">
        <van-field
          label="属性标识符"
          placeholder="请选择或输入属性标识符"
          value="{{ propertyIdentifier }}"
          readonly
          bind:click="onOpenPropertySelector"
          border="{{ false }}"
        />
        
        <view class="time-range">
          <van-field
            label="开始时间"
            placeholder="选择开始时间"
            value="{{ historyStartTime }}"
            readonly
            bind:click="onStartTimeChange"
            border="{{ false }}"
          />
          <van-field
            label="结束时间"
            placeholder="选择结束时间"
            value="{{ historyEndTime }}"
            readonly
            bind:click="onEndTimeChange"
            border="{{ false }}"
          />
        </view>
        
        <view class="form-actions">
          <van-button type="primary" size="small" bind:click="onQueryHistory" loading="{{historyLoading}}">
            {{historyLoading ? '查询中...' : '查询历史数据'}}
          </van-button>
        </view>
      </view>
    </view>

    <!-- 历史数据列表 -->
    <view class="history-data-card" wx:if="{{historyData.length > 0 || historyLoading}}">
      <view class="card-title">
        <text wx:if="{{!historyLoading}}">历史数据 ({{historyData.length}})</text>
        <text wx:else>历史数据 (加载中...)</text>
      </view>
      <view class="history-list">
        <!-- 历史数据加载中 -->
        <view class="history-item" wx:if="{{historyLoading}}">
          <view class="history-header">
            <text class="history-property">加载中...</text>
          </view>
          <view class="history-value">
            <view class="loading-placeholder">
              <van-loading type="spinner" size="16px" color="#07c160" />
              <text>正在查询历史数据</text>
            </view>
          </view>
        </view>
        
        <!-- 历史数据列表 -->
        <view class="history-item" wx:for="{{historyData}}" wx:key="timestamp" wx:if="{{!historyLoading}}">
          <view class="history-header">
            <text class="history-property">{{item.property}}</text>
            <text class="history-time">{{formatTimestamp(item.timestamp)}}</text>
          </view>
          <view class="history-value">
            <text class="value-text">{{item.data}}</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- 时间选择器弹窗 -->
  <van-popup show="{{ showStartTimePicker }}" position="bottom" bind:close="onStartTimePickerClose">
    <van-datetime-picker
      type="date"
      value="{{ historyStartTs }}"
      min-date="{{ minDate }}"
      max-date="{{ maxDate }}"
      bind:confirm="onStartTimeConfirm"
      bind:cancel="onStartTimePickerClose"
    />
  </van-popup>

  <van-popup show="{{ showEndTimePicker }}" position="bottom" bind:close="onEndTimePickerClose">
    <van-datetime-picker
      type="date"
      value="{{ historyEndTs }}"
      min-date="{{ minDate }}"
      max-date="{{ maxDate }}"
      bind:confirm="onEndTimeConfirm"
      bind:cancel="onEndTimePickerClose"
    />
  </van-popup>

  <!-- 枚举选择器弹窗 -->
  <van-popup show="{{ showEnumPicker }}" position="bottom" bind:close="onEnumCancel">
    <van-picker
      columns="{{ enumPickerColumns }}"
      bind:confirm="onEnumConfirm"
      bind:cancel="onEnumCancel"
    />
  </van-popup>

  <!-- 属性选择器弹窗 -->
  <van-popup show="{{ showPropertyPicker }}" position="bottom" bind:close="onPropertyCancel">
    <van-picker
      columns="{{ propertyPickerColumns }}"
      bind:confirm="onPropertyConfirm"
      bind:cancel="onPropertyCancel"
    />
  </van-popup>
</view>
