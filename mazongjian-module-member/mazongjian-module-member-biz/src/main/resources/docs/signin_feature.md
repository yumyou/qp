# 签到功能实现说明

## 功能概述

本签到功能为小程序用户提供每日签到获得积分的功能，支持连续签到奖励机制。

## 数据库表结构

### 1. 门店用户积分字段
- `member_store_user.gift_balance` - 用户积分字段（使用现有的giftBalance字段）
- 积分按门店分别管理，每个门店的积分独立计算

### 2. 签到记录表 (member_user_signin)
- `id` - 签到记录ID
- `user_id` - 用户ID
- `signin_date` - 签到日期
- `consecutive_days` - 连续签到天数
- `points_earned` - 本次获得积分

### 3. 积分记录表 (member_user_points)
- `id` - 积分记录ID
- `user_id` - 用户ID
- `points` - 积分变动数量
- `total_points` - 变动后总积分
- `source_type` - 积分来源类型
- `source_id` - 来源记录ID
- `description` - 积分变动描述

### 4. 签到配置表 (member_signin_config)
- `id` - 配置ID
- `consecutive_days` - 连续签到天数
- `points_reward` - 奖励积分
- `description` - 奖励描述
- `status` - 状态

## API接口

### 1. 获取签到信息
- **接口**: `GET /member/signin/info`
- **参数**: `storeId` - 门店ID
- **功能**: 获取用户签到状态、连续天数、总积分等信息
- **返回**: 
  ```json
  {
    "consecutiveDays": 5,
    "totalPoints": 100,
    "todaySigned": false,
    "todayDate": "2025-01-29"
  }
  ```

### 2. 执行签到
- **接口**: `POST /member/signin/do`
- **参数**: `storeId` - 门店ID
- **功能**: 执行签到操作，获得积分奖励
- **返回**:
  ```json
  {
    "success": true,
    "pointsEarned": 20,
    "consecutiveDays": 6,
    "totalPoints": 120,
    "description": "连续6天签到奖励"
  }
  ```

### 3. 获取积分记录
- **接口**: `GET /member/signin/points/records`
- **参数**: `limit` - 限制条数
- **功能**: 获取用户积分变动记录
- **返回**:
  ```json
  [
    {
      "id": 1,
      "points": 20,
      "totalPoints": 120,
      "sourceType": "SIGNIN",
      "description": "连续6天签到奖励",
      "createTime": "2025-01-29T10:30:00"
    }
  ]
  ```

## 业务逻辑

### 签到规则
1. 每日只能签到一次
2. 连续签到天数从1开始计算
3. 如果昨天未签到，连续天数重置为1
4. 根据连续天数给予不同积分奖励

### 积分奖励配置
- 每日签到：10积分
- 连续2天签到：15积分
- 连续3天签到：20积分
- 连续7天签到：50积分
- 连续15天签到：100积分
- 连续30天签到：200积分

### 积分系统集成
- 积分存储在门店用户表的`gift_balance`字段中（使用现有字段）
- 积分按门店分别管理，每个门店的积分独立计算
- 所有积分变动都有详细记录
- 支持多种积分来源类型（签到、消费、管理员调整等）

## 前端集成

### 小程序页面更新
- 更新了`qp/pages/signIn/signIn.js`
- 集成了真实的API调用
- 支持获取签到信息和执行签到
- 支持获取积分记录列表

### 主要功能
1. **获取签到信息** - 显示连续天数、总积分、今日签到状态
2. **执行签到** - 点击签到按钮获得积分奖励
3. **积分记录** - 显示历史积分变动记录
4. **积分规则** - 显示积分获取规则说明

## 部署说明

### 1. 数据库初始化
执行以下SQL文件：
- `signin_tables.sql` - 创建表结构
- `test_signin_data.sql` - 插入测试数据（可选）

### 2. 后端部署
- 确保所有Java类文件已编译
- 重启应用服务
- 验证API接口可访问

### 3. 前端更新
- 更新小程序代码
- 重新编译发布小程序

## 测试验证

### 1. 功能测试
- 测试获取签到信息接口
- 测试执行签到接口
- 测试获取积分记录接口
- 测试连续签到逻辑

### 2. 数据验证
- 检查用户giftBalance积分是否正确更新
- 检查签到记录是否正确保存
- 检查积分记录是否正确记录

## 注意事项

1. **事务处理** - 签到操作使用事务确保数据一致性
2. **重复签到** - 系统会检查今日是否已签到，防止重复
3. **连续天数** - 如果昨天未签到，连续天数会重置
4. **积分一致性** - 确保门店用户表giftBalance与积分记录表一致
5. **错误处理** - 完善的错误处理和用户提示

## 扩展功能

### 可扩展的功能
1. **积分商城** - 使用积分兑换商品
2. **积分等级** - 根据积分设置用户等级
3. **积分活动** - 特殊时期的积分翻倍活动
4. **积分统计** - 积分排行榜和统计功能
5. **积分过期** - 设置积分有效期机制
